{% extends 'base.html' %}

{% load static %}

{% load crispy_forms_tags %}

{% block content %}

<!-- Begin page content -->

<main class="flex-shrink-0">
	<div class="container" align="center">

		<p>&nbsp;</p>
		<p>&nbsp;</p>
		{% if user.is_authenticated %}
			{% if link.owner == user %}
			<h3 class="mt-3">Update Alias: {{ link.short_alias }}</h3>
			<br />

			<form id="shorten-form" method="POST">
				{% csrf_token %}
				{{ form|crispy }}
				<button type="submit" class="btn btn-primary rounded-pill px-3">Update</button>
			</form>

			<p>&nbsp;</p>

			{% else %}
			<h3>You are not authorized to view this page.</h3>
			{% endif %}

		{% else %}
		<p>Please <a href="{% url 'login' %}">login</a> to see this page.</p>
		{% endif %}

	<!-- container end -->
	</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
<script>
$(document).ready(function() {
	var existingTags = {{ form.tags.value|safe }}; // Load existing tags from Django
	$("#tags-input").select2({
		tags: true,  // Allow users to create new tags
		tokenSeparators: [','],  // Split tags by comma
		minimumInputLength: 1,  // Show suggestions after typing 1 character
		ajax: {
			url: "{% url 'tags_autocomplete' %}",
			dataType: 'json',
			delay: 250,
			data: function(params) {
				return { term: params.term };
			},
			processResults: function(data) {
				//return { results: data.map(tag => ({ id: tag.id, text: tag.text })) };
				return { results: data };
			}
		},
		// Ensure Select2 sends tags as plain strings
		createTag: function(params) {
			return {id: String(params.term), text: String(params.term)};
		}
	});
	// Preload existing tags when editing
	if (existingTags) {
		var tagList = existingTags.map(tag => ({ id: tag, text: tag }));
		$("#tags-input").select2("data", tagList);
	}
});

</script>

</main>

{% endblock %}
