{% extends 'base.html' %}

{% load static %}

{% load crispy_forms_tags %}

{% block content %}

<!-- Begin page content -->

<main class="flex-shrink-0">
	<div class="container" align="center">

		<p>&nbsp;</p>
		<p>&nbsp;</p>
		{% if user.is_authenticated %}
		
		<h3 class="mt-3">Update: {{ link.short_alias }}</h3>
		<br />

		<form id="shorten-form" method="POST" action="?page={{ page }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}">
			{% csrf_token %}
			{{ form|crispy }}
		
			<!-- <input type="text" id="tag-input" class="form-control" placeholder="Enter tags" />
			<div id="selected-tags" class="mt-2"></div><br />
 -->
			<button type="submit" class="btn btn-primary rounded-pill px-3">Update</button>
			<input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
		</form>

		<p>&nbsp;</p>

		{% else %}
		<p>Please <a href="{% url 'login' %}">login</a> to see this page.</p>
		{% endif %}

	<!-- container end -->
	</div>

	<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
	<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
	<script>
		$(document).ready(function() {
		    var existingTags = JSON.parse('{{ form.tags.value|escapejs }}'); // Load existing tags from Django
		    console.log("Existing tags:", existingTags);

		    $("#tag-input").select2({
		        tags: true,  // Allow users to create new tags
		        tokenSeparators: [','],  // Split tags by comma
		        minimumInputLength: 1,  // Show suggestions after typing 1 character
		        ajax: {
		            url: "{% url 'tags-suggestions' %}",
		            dataType: 'json',
		            delay: 250,
		            data: function(params) {
		                console.log("Fetching suggestions for:", params.term);
		                return { term: params.term };
		            },
		            processResults: function(data) {
		                console.log("Received suggestions:", data);
		                return { results: data };
		            }
		        },
		        // Ensure Select2 sends tags as plain strings
		        createTag: function(params) {
		            return {id: String(params.term), text: String(params.term)};
		        }
		    });

		    // Preload existing tags when editing
		    if (existingTags) {
		        var tagList = existingTags.map(tag => ({ id: tag, text: tag }));
		        $("#tag-input").select2("data", tagList);
		    }

		    $('#tag-input').on('select2:select', function(e) {
		        var data = e.params.data;
		        console.log("Selected tag:", data);
		        $('#selected-tags').append('<span class="badge bg-primary me-1">' + data.text + '</span>');
		    });
		});
	</script>

</main>

{% endblock %}
